<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>外壁塗装 見積り — 連絡先入力</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="preconnect" href="https://zipcloud.ibsnet.co.jp" />
  <style>
    :root { --p:#16a34a; --g:#10b981; --t:#111; --m:#666; }
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .wrap{max-width:640px;margin:0 auto;padding:16px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px;}
    .h1{font-size:20px;font-weight:700;margin:0 0 4px;}
    .p{font-size:14px;color:#444;margin:0 0 16px;line-height:1.6}
    .note{font-size:12px;color:#666;margin-top:8px}
    .row{margin:12px 0}
    label{display:block;font-size:13px;color:#333;margin:0 0 6px}
    input[type=text],input[type=tel]{width:100%;font-size:16px;padding:12px;border:1px solid #ddd;border-radius:12px;outline:none}
    input[type=text]:focus,input[type=tel]:focus{border-color:#16a34a}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;border:none;background:var(--p);color:#fff;font-size:16px;width:100%}
    .btn[disabled]{opacity:.5}
    .btn-secondary{background:#e5e7eb;color:#111}
    .bar{height:8px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 0 16px}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--p),var(--g));width:0%}
    .row2{display:flex;gap:8px}
    .row2>*{flex:1}
    .foot{display:flex;gap:8px;margin-top:12px}
    .ok{color:#16a34a;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="h1">詳しい見積りのご依頼</div>
      <p class="p">現地調査なしで、詳細な見積りをLINEでお知らせします。下記の連絡先をご入力ください。</p>
      <div class="bar"><i id="prog" style="width:25%"></i></div>

      <div id="step1">
        <div class="row">
          <label>お名前</label>
          <input id="name" type="text" inputmode="text" placeholder="例）山田 太郎" />
        </div>
        <div class="note">お住まいの区画を確認するためのご入力です。現地調査や営業訪問は致しませんのでご安心ください。</div>
        <div class="foot">
          <button class="btn" id="to2">次へ</button>
        </div>
      </div>

      <div id="step2" style="display:none">
        <div class="row">
          <label>郵便番号（7桁・ハイフン不要）</label>
          <input id="postal" type="tel" pattern="\d*" inputmode="numeric" placeholder="例）1234567" maxlength="8" />
        </div>
        <div class="foot">
          <button class="btn btn-secondary" id="back1">戻る</button>
          <button class="btn" id="to3">次へ</button>
        </div>
      </div>

      <div id="step3" style="display:none">
        <div class="row">
          <label>住所（都道府県・市区町村・番地など）</label>
          <input id="addr1" type="text" inputmode="text" placeholder="自動補完されます。未入力の場合は手入力してください" />
        </div>
        <div class="row">
          <label>番地など以降の住所や建物名・部屋番号など</label>
          <input id="addr2" type="text" inputmode="text" placeholder="無ければ「なし」" />
        </div>
        <div class="foot">
          <button class="btn btn-secondary" id="back2">戻る</button>
          <button class="btn" id="submit">送信する</button>
        </div>
      </div>

      <div id="done" style="display:none">
        <p class="p ok">送信しました。トークにメッセージを送りました。</p>
        <button class="btn" id="close">LINEに戻る</button>
      </div>
    </div>
  </div>

  <script>
    // ★ あなたの LIFF ID を入れてください
    const LIFF_ID = '2007914959-XP5Rpoay';

    const qs = sel => document.querySelector(sel);
    const prog = qs('#prog');
    const step1 = qs('#step1'), step2 = qs('#step2'), step3 = qs('#step3'), done = qs('#done');

    function show(n){
      step1.style.display = n===1?'':'none';
      step2.style.display = n===2?'':'none';
      step3.style.display = n===3?'':'none';
      done.style.display  = n===4?'':'none';
      prog.style.width = (n*25)+'%';
    }

    async function init(){
      await liff.init({ liffId: LIFF_ID });
      // LIFF v2: トーク内起動を想定。未ログインなら login。
      if (!liff.isLoggedIn()) liff.login();
    }

    async function autoAddress(zip){
      if (!/^\d{7}$/.test(zip)) return;
      const r = await fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode='+zip);
      const j = await r.json();
      if (j?.results && j.results[0]) {
        const a = j.results[0];
        const addr = `${a.address1}${a.address2}${a.address3}`;
        qs('#addr1').value = addr;
      }
    }

    qs('#to2').onclick = () => {
      if (!qs('#name').value.trim()) { alert('お名前を入力してください'); return; }
      show(2);
    };
    qs('#back1').onclick = () => show(1);

    qs('#to3').onclick = async () => {
      const p = qs('#postal').value.replace(/[^\d]/g,'');
      if (!/^\d{7}$/.test(p)) { alert('郵便番号は7桁で入力してください'); return; }
      await autoAddress(p);
      show(3);
    };
    qs('#back2').onclick = () => show(2);

    qs('#submit').onclick = async () => {
      const name  = qs('#name').value.trim();
      const postal= qs('#postal').value.replace(/[^\d]/g,'');
      const addr1 = qs('#addr1').value.trim();
      const addr2 = qs('#addr2').value.trim();

      if (!name) { alert('お名前を入力してください'); return; }
      if (!/^\d{7}$/.test(postal)) { alert('郵便番号は7桁で入力してください'); return; }
      if (!addr1) { alert('住所（都道府県〜番地）を入力してください'); return; }

      const payload = { name, postal, addr1, addr2 };
      try {
        await liff.sendMessages([{ type:'text', text: 'CONTACT:' + JSON.stringify(payload) }]);
        show(4);
      } catch (e) {
        console.error(e); alert('送信に失敗しました。LINEアプリ内で開いているか確認してください。');
      }
    };

    qs('#close').onclick = () => liff.closeWindow();

    init().then(()=>show(1));
  </script>
</body>
</html>
