<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LINEを開いています…</title>
  <style>
    :root {
      color-scheme: light dark;
    }
    body {
      margin: 0; padding: 24px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
      line-height: 1.7;
    }
    .wrap { max-width: 720px; margin: 0 auto; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    p { margin: 0 0 16px; }
    .hint { opacity: .72; font-size: .95rem; }
    .btns { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
    a.btn, button.btn {
      display: inline-block;
      padding: 12px 16px;
      border-radius: 10px;
      text-decoration: none;
      border: 0;
      background: #06C755; /* LINE green */
      color: #fff; font-weight: 700;
    }
    .ghost { background: transparent; color: inherit; border: 1px solid currentColor; }
    code { padding: 2px 6px; background: #0000000d; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap" id="root">
    <h1>LINEを開いています…</h1>
    <p>数秒たっても自動で開かない場合は、下のボタンをタップしてください。</p>
    <div class="btns" id="fallback" style="display:none">
      <a class="btn" id="openLine" href="#" rel="noopener">LINEを開く</a>
      <a class="btn ghost" href="/" rel="noopener">トップに戻る</a>
    </div>
    <p class="hint">※ iOS/Safari では OS の仕様により、外部アプリ起動時に確認ダイアログが表示される場合があります。</p>
  </div>

  <script>
    // ===== 設定の受け取り =====
    // クエリパラメータ:
    //   oa   : ベーシックID（@から始まる） 例: @004szogc
    //   msg  : 事前入力するメッセージ（任意）
    //   add  : 友だち追加URL（任意。指定が無いときは oaMessage を使う）
    const sp = new URLSearchParams(location.search);
    const OA_BASIC_ID = sp.get('oa');                         // 例: @004szogc
    const PREFILL = sp.get('msg') || '見積結果を確認したいです';
    const ADD_URL = sp.get('add') || '';                      // 例: https://line.me/R/ti/p/@004szogc

    // トークを直接開く（友だち未追加なら追加→トーク）
    const OA_MESSAGE_URL = OA_BASIC_ID
      ? `https://line.me/R/oaMessage/${encodeURIComponent(OA_BASIC_ID)}/?${encodeURIComponent(PREFILL)}`
      : (ADD_URL || 'https://line.me');

    // ===== 自動起動 + フォールバック =====
    const fallbackEl = document.getElementById('fallback');
    const openBtn = document.getElementById('openLine');
    openBtn.href = OA_MESSAGE_URL;

    function tryOpenLine(url, timeoutMs) {
      return new Promise((resolve, reject) => {
        let done = false;
        const t = setTimeout(() => { if (!done) { done = true; reject(new Error('timeout')); }}, timeoutMs || 2000);
        const onVis = () => {
          if (document.visibilityState === 'hidden' && !done) {
            done = true; clearTimeout(t); document.removeEventListener('visibilitychange', onVis);
            resolve();
          }
        };
        document.addEventListener('visibilitychange', onVis, { passive: true });
        // 実際の遷移
        location.assign(url);
      });
    }

    (async () => {
      try {
        await tryOpenLine(OA_MESSAGE_URL, 2000);
        // 別アプリに切り替わった → 何もしない（成功）
      } catch {
        // 起動できなかった → フォールバック
        fallbackEl.style.display = 'block';
      }
    })();
  </script>
</body>
</html>
